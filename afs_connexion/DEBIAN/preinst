#!/bin/bash
set -e

# Variables
afs_configuration_file_location="$HOME/.afs/configuration.conf"
ssh_configuration_location="$HOME/.ssh/config"
afs_configuration_location="$HOME/.afs"
host_configuration="Host git.cri.epita.fr
  GSSAPIAuthentication yes
                       
Host ssh.cri.epita.fr
  GSSAPIAuthentication yes
  GSSAPIDelegateCredentials yes"

# Language selection
language=$(whiptail --title "Configuration" --menu "Choix de la langue | Language selection" 10 60 2 \
"fr" "FranÃ§ais" \
"en" "English" 3>&1 1>&2 2>&3)

# Loading language files
source "./lang/lang_$language.sh"

# Message display function
function message {
  (whiptail --title "$title" --msgbox "$1" 10 60)
}

# User name recovery
if [ -f "$afs_configuration_file_location" ]; then
    username=$(grep USER "$afs_configuration_file_location" | cut -d= -f2)
else
    username=$(whiptail --title "$title" --inputbox "$msg_enter_username" 10 60 3>&1 1>&2 2>&3)
    if [ $? -ne 0 ]; then
        message "$msg_installation_cancelled"
        exit 1
    fi
fi

# SSH configuration

if [ ! -f "$ssh_configuration_location" ]; then 
  touch "$ssh_configuration_location" 
fi 
if ! grep -q "Host git.cri.epita.fr" "$ssh_configuration_location"; then 
  echo "$host_configuration" >> "$ssh_configuration_location" 
fi

# Create configuration directory if necessary
mkdir -p "$afs_configuration_location"

# User name registration
echo "USERNAME=$username" > "$afs_configuration_file_location"
echo "LANGUAGE=$language" >>"$afs_configuration_file_location"

message "$msg_installation_complete"
